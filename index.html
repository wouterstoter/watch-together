<!DOCTYPE>
<html>
  <head>
    <title>Watch Together</title>
    <script src='https://meet.jit.si/external_api.js'></script>
    <script src='https://cdn.jsdelivr.net/hls.js/latest/hls.min.js'></script>
    <style>
      :focus {
        outline: none;
      }
      body {
        margin: 0;
        display: flex;
        flex-direction: row;
        background: black;
        height: 100%;
      }
      body > #video {
        width: 0;
        height: 100%;
        flex-shrink: 1;
        flex-grow: 1;
        background: black;
        position:relative;
        overflow:hidden;
      }
      body > #video > #overlay {
        position: absolute;
        width: 100%;
        height: 100%;
        background: #00000078;
        color: white;
        z-index: 1;
        text-align: center;
        font-family: sans-serif;
        font-size: xx-large;
        padding: 20px;
        box-sizing: border-box;
        cursor:pointer;
      }
      body > #video > #upload  {
        position: absolute;
        width: 100%;
        height: 100%;
        background: #00000078;
        color: white;
        z-index: 1;
        text-align: center;
        font-family: sans-serif;
        font-size: xx-large;
        padding: 20px;
        box-sizing: border-box;
      }
      body > #video > video {
        width:100%;
        height:100%;
      }
      body > #meet {
        width: 140px;
        flex-shrink: 0;
        flex-grow: 0;
        background: rgb(27, 38, 56);
        position:relative;
      }
      #fileoptions {
        position: absolute;
        right: 5px;
        top: 20px;
        text-align: right;
        width: 38px;
      }
      #fileoptions > button {
        font-family: Material Icons;
        border: none;
        background: none;
        color: white;
        font-size: 24px;
        padding: 7px;
        cursor: pointer;
      }
    </style>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  </head>
  <body>
    <div id="video">
      <div id="overlay">Click here to open a video</div>
      <div id="upload" style="display:none;">Uploading <i>video</i><br><progress id="file" max="1" value="0">0%</progress></div>
      <video controls></video>
    </div>
    <div id="meet" style="width:100%;">
      <div id="fileoptions" style="display:none;">
        <button id="upload" title="Open Video from files">folder_open</button>
        <button id="open" title="Open Video from URL">link</button>
        <button id="play" title="Play/Pause video">play_arrow</button>
        <button id="speed" title="Change Playback speed">speed</button>
        <button id="sync" title="Synchronize video with other participants">sync</button>
        <button id="remove" title="Remove video from servers">delete</button>
        <button id="info" title="Info about the program">info</button>
      </div>
    </div>
    <script>
      const api = new JitsiMeetExternalAPI('meet.jit.si', {
        roomName: (document.location.hash || (document.location.hash = "#" + prompt("Please enter room name"))).slice(1),
        width: "100%",
        height: "100%",
        parentNode: document.querySelector('#meet'),
        configOverwrite: {
          useNicks: false,
          requireDisplayName: false,
          enableDisplayNameInStats: false,
          enableClosePage: false,
          doNotStoreRoom: true,
          displayJids: false
        },
        interfaceConfigOverwrite: {
          filmStripOnly: true,
          DEFAULT_REMOTE_DISPLAY_NAME: '',
          DEFAULT_LOCAL_DISPLAY_NAME: '',
          SHOW_CHROME_EXTENSION_BANNER: false,
          MOBILE_APP_PROMO: false
        }
      });
      var laststate;
      var ignore = false;
      var src;
      api.addEventListener("endpointTextMessageReceived", async function(e){
        var data = e.data.eventData.text;
        console.log(data);
        if (data == "stateRequest") {
          laststate = {
            "src":src,
            "paused":video.paused,
            "currentTime":video.currentTime,
            "event":"stateRequest",
            "playbackRate":video.playbackRate,
          }
          api.executeCommand("sendEndpointTextMessage",e.data.senderInfo.id,laststate)
        } else if (data.event == "remove") {
          remove();
        }  else if (data.event == "upload") {
          if (data.progress == "start") {
            video.pause();
            document.querySelector("div#upload > i").innerText = data.name;
            document.querySelector("div#upload").style.display = "";
            document.querySelector("div#overlay").style.display = "none";
          } else if (data.progress == "done") {
            document.querySelector("div#upload > i").innerText = "video";
            document.querySelector("div#upload").style.display = "none";
            document.querySelector("div#upload > progress").value = 0;
          } else {
            document.querySelector("div#upload > progress").value = data.progress;
          }
        } else if (!laststate || JSON.stringify(laststate, Object.keys(laststate).sort()) != JSON.stringify(data, Object.keys(data).sort())) {
          ignore = true;
          if (data.src && src != data.src) {src = data.src;loadVid();}
          if (data.event == "waiting" || data.event == "pause" || data.event == "seeked" || data.event == "stateRequest") {
            if (Math.abs(data.currentTime - video.currentTime) > 0.5 && (!laststate || data.currentTime != laststate.currentTime)) video.currentTime = data.currentTime;
          }
          if (data.playbackRate != video.playbackRate) video.playbackRate = data.playbackRate;
          if (data.paused != video.paused && data.event != "waiting") data.paused ? await video.pause() : await video.play();
          if (data.event == "waiting") await video.pause();
          laststate = data;
          setTimeout(a => {ignore = false},100)
        }
      });
      api.addEventListener("videoConferenceJoined", function(e){
        document.querySelector("#meet").style.width = "";
        document.querySelector("#fileoptions").style.display = "";
        console.log(api._participants);
        setTimeout(e => {
          if (Object.keys(api._participants).length > 1) api.executeCommand("sendEndpointTextMessage",Object.keys(api._participants).filter(a => a != api._myUserID)[0],"stateRequest")
        },1000)
      });
      const video = document.querySelector('video');
      function sendState(e){
        document.querySelector("button#play").innerText = video.paused ? "play_arrow" : "pause";
        if (!ignore) {
          console.log(e);
          for (participantId in api._participants) {
            laststate = {
              "src":src,
              "paused":video.paused,
              "currentTime":video.currentTime,
              "event":e.type,
              "playbackRate":video.playbackRate,
            }
            api.executeCommand("sendEndpointTextMessage",participantId,laststate)
          }
        }
      }
      function open(){
        src = prompt("What is the URL of the video you want to play?")
        sendState({"type":"newVid"});
        loadVid();
      }
      document.querySelector("#overlay").addEventListener("click", open);
      document.querySelector("button#open").addEventListener("click", open);
      var fileupload = {};
      document.querySelector("button#upload").addEventListener("click", function() {
        deleteFile();
        fileupload = {};
        var input = document.createElement("input");
        input.setAttribute("type", "file");
        input.setAttribute("accept", "video/*");
        input.onchange = function() {
          if (this.files.length > 0) {
            fileupload.file = this.files[0];
            document.querySelector("#overlay").style.display = "none";
            fileupload.objectURL = URL.createObjectURL(fileupload.file);
            video.src = fileupload.objectURL;
            fetch('https://apiv2.gofile.io/getServer')
              .then(response => response.json())
              .then(data => {
                if (data.status != "ok") return;
                fileupload.server = data.data.server;
                var formData = new FormData();
                formData.append("filesUploaded",fileupload.file);
                var expire = new Date();
                expire.setHours(expire.getHours()+5);
                formData.append("expire",Number(expire));
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "https://" + fileupload.server + ".gofile.io/upload");
                xhr.upload.onprogress = function (e) {
                  if (e.lengthComputable) {
                    video.currentTime = Math.round(e.loaded / e.total * 20) / 20 * video.duration;
                    document.querySelector("div#upload > progress").value = e.loaded / e.total;
                    for (participantId in api._participants) {
                      api.executeCommand("sendEndpointTextMessage",participantId,{
                        "name":fileupload.file.name,
                        "event":"upload",
                        "progress":e.loaded / e.total,
                      })
                    }
                  }
                }
                xhr.upload.onloadstart = function (e) {
                  ignore = true;
                  video.pause();
                  document.querySelector("div#upload > i").innerText = fileupload.file.name;
                  document.querySelector("div#upload").style.display = "";
                  for (participantId in api._participants) {
                    api.executeCommand("sendEndpointTextMessage",participantId,{
                      "name":fileupload.file.name,
                      "event":"upload",
                      "progress":"start",
                    })
                  }
                }
                xhr.upload.onloadend = function (e) {
                  video.currentTime = 0;
                  ignore = false;
                  document.querySelector("div#upload > i").innerText = "video";
                  document.querySelector("div#upload").style.display = "none";
                  document.querySelector("div#upload > progress").value = 0;
                  for (participantId in api._participants) {
                    api.executeCommand("sendEndpointTextMessage",participantId,{
                      "name":fileupload.file.name,
                      "event":"upload",
                      "progress":"done",
                    })
                  }
                }
                xhr.onreadystatechange = function() {
                  if (this.readyState == 4 && this.status == 200) {
                    var data = JSON.parse(this.responseText);
                    if (data.status != "ok") return
                    fileupload.code = data.data.code;
                    fileupload.removalCode = data.data.removalCode;
                    src = "https://gofile.io/?c=" + fileupload.code;
                    sendState({"type":"newVid"});
                  }
                }
                xhr.send(formData);
              });
          }
        }
        input.click();
      });
      document.querySelector("button#play").addEventListener("click", e => {video.paused ? video.play() : video.pause()});
      document.querySelector("button#speed").addEventListener("click", e => {video.playbackRate = Number(prompt("What playback speed do you want?",video.playbackRate)) || video.playbackRate});
      document.querySelector("button#sync").addEventListener("click", e => {if (Object.keys(api._participants).length > 1) api.executeCommand("sendEndpointTextMessage",Object.keys(api._participants).filter(a => a != api._myUserID)[0],"stateRequest")});
      document.querySelector("button#info").addEventListener("click", e => {alert('This program is powered by the amazing video calling service of Jitsi (https://jitsi.org/) to make it possible to (video)call with eachother, and the awesome filesharing service GoFile.io (https://gofile.io/) to make it possible to upload your own videos to watch together. Please go to their websites and give them some love!')});
      function deleteFile() {
        if (fileupload && fileupload.code && fileupload.server && fileupload.removalCode) {
          fetch('https://' + fileupload.server + '.gofile.io/deleteUpload?c=' + fileupload.code + "&rc=" + fileupload.removalCode + "&removeAll=true")
            .then(response => response.json())
            .then(data => {
              if (data.status != "ok") return;
            })
        }
      }
      function remove() {
        video.src = "";
        document.querySelector("#overlay").style.display = "";
        src = "";
        deleteFile();
        fileupload = {};
      }
      document.querySelector("button#remove").addEventListener("click", function() {
        remove();
        sendState({"type":"remove"});
      });
      function loadVid() {
        deleteFile();
        if (src) {
          document.querySelector("#overlay").style.display = "none";
          var link = new URL(src);
          if (link.hostname == "gofile.io") {
            fileupload = {};
            fileupload.code = link.searchParams.get('c');
            fetch('https://apiv2.gofile.io/getServer?c=' + fileupload.code)
              .then(response => response.json())
              .then(data => {
                if (data.status != "ok") return;
                fileupload.server = data.data.server;
                fetch('https://' + fileupload.server + '.gofile.io/getUpload?c=' + fileupload.code)
                  .then(response => response.json())
                  .then(data => {
                    if (data.status != "ok") return;
                    video.src = data.data.files[0].link;
                  })
              })
          } else {
            var ext = link.pathname.split("/").slice(-1)[0].split(".").slice(-1)[0]
            if(Hls.isSupported() && ext == "m3u8") {
              var hls = new Hls();
              hls.loadSource(src);
              hls.attachMedia(video);
            } else {
              video.src = src;
            }
          }
        }
      }
      api.addEventListener("readyToClose", function(e){
        document.querySelector("#meet").style.width = 0;
        deleteFile();
      });
      video.addEventListener("play", sendState);
      video.addEventListener("pause", sendState);
      video.addEventListener("seeked", sendState);
      video.addEventListener("waiting", sendState);
      video.addEventListener("playing", sendState);
      video.addEventListener("ratechange", sendState);
      video.addEventListener("canplay", function() {
        if (!ignore && Object.keys(api._participants).length > 1) api.executeCommand("sendEndpointTextMessage",Object.keys(api._participants).filter(a => a != api._myUserID)[0],"stateRequest")
      });
      window.addEventListener("beforeunload", function (e) {
        deleteFile();
      });
    </script>
  </body>
</html>
