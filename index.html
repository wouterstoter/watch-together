<!DOCTYPE>
<html>
  <head>
    <title>Watch Together</title>
    <script src='https://meet.jit.si/external_api.js'></script>
    <script src='https://cdn.jsdelivr.net/hls.js/latest/hls.min.js'></script>
    <style>
      :focus {
        outline: none;
      }
      body {
        margin: 0;
        display: flex;
        flex-direction: row;
        background: black;
        height: 100%;
      }
      body > #video {
        width: 0;
        height: 100%;
        flex-shrink: 1;
        flex-grow: 1;
        background: black;
        position:relative;
        overflow:hidden;
      }
      body > #video > #overlay {
        position: absolute;
        width: 100%;
        height: 100%;
        background: #00000078;
        color: white;
        z-index: 1;
        text-align: center;
        font-family: sans-serif;
        font-size: xx-large;
        padding: 20px;
        box-sizing: border-box;
        cursor:pointer;
      }
      body > #video > video {
        width:100%;
        height:100%;
      }
      body > #meet {
        width: 140px;
        flex-shrink: 0;
        flex-grow: 0;
        background: rgb(27, 38, 56);
        position:relative;
      }
      #fileoptions {
        position: absolute;
        right: 5px;
        top: 20px;
        text-align: right;
        width: 38px;
      }
      #fileoptions > button {
        font-family: Material Icons;
        border: none;
        background: none;
        color: white;
        font-size: 24px;
        padding: 7px;
        cursor: pointer;
      }
    </style>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  </head>
  <body>
    <div id="video">
      <div id="overlay">Click here to open a video</div>
      <video controls></video>
    </div>
    <div id="meet" style="width:100%;">
      <div id="fileoptions" style="display:none;">
        <button id="open" title="Open Video from URL">folder_open</button>
        <button id="play" title="Play/Pause video">play_arrow</button>
        <button id="speed" title="Change Playback speed">speed</button>
        <button id="sync" title="Synchronize video with other participants">sync</button>
      </div>
    </div>
    <script>
      const api = new JitsiMeetExternalAPI('meet.jit.si', {
        roomName: (document.location.hash || (document.location.hash = "#" + prompt("Please enter room name"))).slice(1),
        width: "100%",
        height: "100%",
        parentNode: document.querySelector('#meet'),
        configOverwrite: {
          useNicks: false,
          requireDisplayName: false,
          enableDisplayNameInStats: false,
          enableClosePage: false,
          doNotStoreRoom: true,
          displayJids: false
        },
        interfaceConfigOverwrite: {
          filmStripOnly: true,
          DEFAULT_REMOTE_DISPLAY_NAME: '',
          DEFAULT_LOCAL_DISPLAY_NAME: '',
          SHOW_CHROME_EXTENSION_BANNER: false,
          MOBILE_APP_PROMO: false
        }
      });
      var laststate;
      var ignore;
      var src;
      api.addEventListener("endpointTextMessageReceived", async function(e){
        var data = e.data.eventData.text;
        console.log(e);
        if (data == "stateRequest") {
          laststate = {
            "src":src,
            "paused":video.paused,
            "currentTime":video.currentTime,
            "event":"stateRequest",
            "playbackRate":video.playbackRate,
          }
          api.executeCommand("sendEndpointTextMessage",e.data.senderInfo.id,laststate)
        } else if (!laststate || JSON.stringify(laststate, Object.keys(laststate).sort()) != JSON.stringify(data, Object.keys(data).sort())) {
          ignore = true;
          if (src != data.src) {src = data.src;loadVid();}
          if (data.event == "waiting" || data.event == "pause" || data.event == "seeked" || data.event == "stateRequest") {
            if (Math.abs(data.currentTime - video.currentTime) > 0.5 && (!laststate || data.currentTime != laststate.currentTime)) video.currentTime = data.currentTime;
          }
          if (data.playbackRate != video.playbackRate) video.playbackRate = data.playbackRate;
          if (data.paused != video.paused && data.event != "waiting") data.paused ? await video.pause() : await video.play();
          if (data.event == "waiting") await video.pause();
          laststate = data;
          setTimeout(a => {ignore = false},100)
        }
      });
      api.addEventListener("readyToClose", function(e){
        document.querySelector("#meet").style.width = 0;
      });
      api.addEventListener("videoConferenceJoined", function(e){
        document.querySelector("#meet").style.width = "";
        document.querySelector("#fileoptions").style.display = "";
        console.log(api._participants);
        setTimeout(e => {
          if (Object.keys(api._participants).length > 1) api.executeCommand("sendEndpointTextMessage",Object.keys(api._participants).filter(a => a != api._myUserID)[0],"stateRequest")
        },1000)
      });
      const video = document.querySelector('video');
      function sendState(e){
        document.querySelector("button#play").innerText = video.paused ? "play_arrow" : "pause";
        //console.log(ignorechanges,e);
        if (!ignore) {
          for (participantId in api._participants) {
            laststate = {
              "src":src,
              "paused":video.paused,
              "currentTime":video.currentTime,
              "event":e.type,
              "playbackRate":video.playbackRate,
            }
            api.executeCommand("sendEndpointTextMessage",participantId,laststate)
          }
        }
      }
      function open(){
        src = prompt("What is the URL of the video you want to play?")
        sendState({"type":"newVid"});
        loadVid();
      }
      document.querySelector("#overlay").addEventListener("click", open);
      document.querySelector("button#open").addEventListener("click", open);
      document.querySelector("button#play").addEventListener("click", e => {video.paused ? video.play() : video.pause()});
      document.querySelector("button#speed").addEventListener("click", e => {video.playbackRate = Number(prompt("What playback speed do you want?",video.playbackRate)) || video.playbackRate});
      document.querySelector("button#sync").addEventListener("click", e => {if (Object.keys(api._participants).length > 1) api.executeCommand("sendEndpointTextMessage",Object.keys(api._participants).filter(a => a != api._myUserID)[0],"stateRequest")});
      function loadVid() {
        if (src) {
          document.querySelector("#overlay").style.display = "none";
          var ext = (new URL(src)).pathname.split("/").slice(-1)[0].split(".").slice(-1)[0]
          if(Hls.isSupported() && ext == "m3u8") {
            var hls = new Hls();
            hls.loadSource(src);
            hls.attachMedia(video);
          } else {
            video.src = src;
          }
        }
      }
      video.addEventListener("play", sendState);
      video.addEventListener("pause", sendState);
      video.addEventListener("seeked", sendState);
      video.addEventListener("waiting", sendState);
      video.addEventListener("playing", sendState);
      video.addEventListener("ratechange", sendState);
      video.addEventListener("canplay", function() {
        if (Object.keys(api._participants).length > 1) api.executeCommand("sendEndpointTextMessage",Object.keys(api._participants).filter(a => a != api._myUserID)[0],"stateRequest")
      });
    </script>
  </body>
</html>
